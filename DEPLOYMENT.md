# üöÄ Render.com Deployment Guide for BridgeIT Backend

This guide provides detailed step-by-step instructions for deploying the BridgeIT Django backend to Render.com.

## üìã Table of Contents

1. [Prerequisites](#prerequisites)
2. [Pre-Deployment Checklist](#pre-deployment-checklist)
3. [Environment Variables Setup](#environment-variables-setup)
4. [Deployment Steps](#deployment-steps)
5. [Post-Deployment Verification](#post-deployment-verification)
6. [Troubleshooting](#troubleshooting)
7. [Media Files Configuration](#media-files-configuration)

---

## Prerequisites

Before deploying, ensure you have:

- ‚úÖ A [Render.com](https://render.com/) account (free tier available)
- ‚úÖ A [GitHub](https://github.com/) account
- ‚úÖ Git installed on your local machine
- ‚úÖ Your project pushed to a GitHub repository
- ‚úÖ Google Gemini API key (for AI resume analysis features)

---

## Pre-Deployment Checklist

### 1. Review Configuration Files

The following files have been configured for Render deployment:

| File | Purpose |
|------|---------|
| `render.yaml` | Infrastructure as Code - defines services |
| `build.sh` | Build script for dependencies and migrations |
| `requirements.txt` | Python dependencies with pinned versions |
| `.env.example` | Example environment variables |
| `settings.py` | Production-ready Django settings |

### 2. Verify Dependencies

Ensure all dependencies are listed in `requirements.txt`:

```bash
pip freeze > requirements.txt
```

### 3. Test Build Script Locally (Optional)

```bash
# Make the script executable
chmod +x build.sh

# Test it (requires PostgreSQL connection)
./build.sh
```

---

## Environment Variables Setup

### Required Environment Variables

After deployment, you'll need to configure these environment variables in Render Dashboard:

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `SECRET_KEY` | Django secret key | Auto-generated by Render |
| `DEBUG` | Debug mode | `False` (production) |
| `ALLOWED_HOSTS` | Allowed hostnames | `your-app.onrender.com` |
| `DATABASE_URL` | PostgreSQL connection | Auto-configured from database |
| `GEMINI_API_KEY` | Google Gemini API key | `AIza...` |
| `CORS_ALLOWED_ORIGINS` | Allowed CORS origins | `https://your-flutter-app.com` |
| `CSRF_TRUSTED_ORIGINS` | Trusted CSRF origins | `https://your-app.onrender.com` |

### Optional Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `WEB_CONCURRENCY` | Gunicorn workers | `4` |
| `CORS_ALLOW_ALL_ORIGINS` | Allow all CORS origins | `False` |
| `SECURE_SSL_REDIRECT` | Force HTTPS redirect | `True` |

---

## Deployment Steps

### Step 1: Prepare Your Repository

1. **Initialize Git** (if not already done):
   ```bash
   git init
   ```

2. **Create/Update .gitignore**:
   Ensure sensitive files are not committed:
   ```
   .env
   *.pyc
   __pycache__/
   db.sqlite3
   staticfiles_build/
   media/
   venv/
   bridge_env/
   venv_old/
   venv_py312/
   ```

3. **Commit all changes**:
   ```bash
   git add .
   git commit -m "Configure for Render deployment"
   ```

4. **Push to GitHub**:
   ```bash
   git remote add origin https://github.com/yourusername/your-repo.git
   git branch -M main
   git push -u origin main
   ```

### Step 2: Create Render Services

#### Option A: Using Blueprint (Recommended)

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **"New +"** ‚Üí **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect `render.yaml` automatically
5. Review the services:
   - **bridgeit-backend** (Web Service)
   - **bridgeit-db** (PostgreSQL Database)
6. Click **"Apply"** to create both services

#### Option B: Manual Setup

If Blueprint doesn't work, create services manually:

**Create Database First:**
1. Click **"New +"** ‚Üí **"PostgreSQL"**
2. Name: `bridgeit-db`
3. Database: `bridgeit_db`
4. User: `bridgeit_user`
5. Region: `Singapore` (or closest to you)
6. Plan: `Free`
7. Click **"Create Database"**
8. **Copy the Internal Database URL** (starts with `postgresql://`)

**Create Web Service:**
1. Click **"New +"** ‚Üí **"Web Service"**
2. Connect your GitHub repository
3. Configure:
   - **Name**: `bridgeit-backend`
   - **Region**: `Singapore`
   - **Branch**: `main`
   - **Runtime**: `Python 3`
   - **Build Command**: `./build.sh`
   - **Start Command**: `gunicorn bridgeit_backend.wsgi:application`
   - **Plan**: `Free`

### Step 3: Configure Environment Variables

In the Render Dashboard, go to your **bridgeit-backend** service:

1. Click **"Environment"** tab
2. Add the following variables:

```
SECRET_KEY = [Auto-generated or use: python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"]
DEBUG = False
ALLOWED_HOSTS = your-app-name.onrender.com
DATABASE_URL = [Copy from bridgeit-db Internal Database URL]
GEMINI_API_KEY = your-gemini-api-key-here
CORS_ALLOWED_ORIGINS = https://your-flutter-app.com
CSRF_TRUSTED_ORIGINS = https://your-app-name.onrender.com
WEB_CONCURRENCY = 4
```

3. Click **"Save Changes"**

### Step 4: Deploy

1. Render will automatically start building and deploying
2. Monitor the **"Logs"** tab for progress
3. Build process will:
   - Install Python dependencies
   - Download spaCy language model
   - Download NLTK data
   - Collect static files
   - Run database migrations

4. Wait for deployment to complete (usually 5-10 minutes for first deploy)

---

## Post-Deployment Verification

### 1. Check Application Health

Visit your deployed URL: `https://your-app-name.onrender.com`

You should see a JSON response:
```json
{
  "message": "Welcome to BridgeIT Backend API",
  "version": "1.0",
  "endpoints": { ... }
}
```

### 2. Verify Admin Panel

1. Go to: `https://your-app-name.onrender.com/admin/`
2. Check if CSS loads correctly (WhiteNoise serving static files)

### 3. Create Superuser

Connect to your Render shell:

1. In Render Dashboard, go to your web service
2. Click **"Shell"** tab
3. Run:
   ```bash
   python manage.py createsuperuser
   ```
4. Follow prompts to create admin account

### 4. Test API Endpoints

Test key endpoints:

```bash
# Health check
curl https://your-app-name.onrender.com/

# API endpoints
curl https://your-app-name.onrender.com/api/auth/
curl https://your-app-name.onrender.com/api/resume/
```

### 5. Test Resume Upload

1. Go to: `https://your-app-name.onrender.com/api/resume/test/`
2. Upload a test resume
3. Verify AI analysis works (requires GEMINI_API_KEY)

---

## Troubleshooting

### Build Failures

**Issue**: Build script fails

**Solutions**:
1. Check **Logs** tab for specific error
2. Common issues:
   - Missing dependencies in `requirements.txt`
   - Syntax errors in `build.sh`
   - Python version mismatch

**Fix**:
```bash
# Verify requirements locally
pip install -r requirements.txt

# Test build script
./build.sh
```

### Database Connection Errors

**Issue**: `django.db.utils.OperationalError`

**Solutions**:
1. Verify `DATABASE_URL` is set correctly
2. Check database is running in Render Dashboard
3. Ensure database allows connections (should be automatic)

**Fix**:
- Copy Internal Database URL from `bridgeit-db` service
- Update `DATABASE_URL` environment variable
- Redeploy

### Static Files Not Loading

**Issue**: Admin panel has no CSS

**Solutions**:
1. Verify WhiteNoise is in `MIDDLEWARE` (already configured)
2. Check `collectstatic` ran successfully in build logs
3. Ensure `STATIC_ROOT` is set correctly

**Fix**:
```bash
# In Render Shell
python manage.py collectstatic --noinput
```

### CORS Errors

**Issue**: Flutter app can't connect to API

**Solutions**:
1. Add your Flutter app domain to `CORS_ALLOWED_ORIGINS`
2. Update `CSRF_TRUSTED_ORIGINS` with your Render URL

**Fix**:
```
CORS_ALLOWED_ORIGINS = https://your-flutter-app.com,https://your-app.onrender.com
CSRF_TRUSTED_ORIGINS = https://your-app-name.onrender.com
```

### Slow First Request

**Issue**: First request after inactivity is very slow

**Explanation**: Render's free tier spins down after 15 minutes of inactivity

**Solutions**:
- Upgrade to paid plan for always-on service
- Accept the cold start delay (30-60 seconds)
- Use a service like UptimeRobot to ping your app every 14 minutes

### Migration Errors

**Issue**: Migrations fail during build

**Solutions**:
1. Check database connection
2. Verify migrations are in version control
3. Run migrations manually

**Fix**:
```bash
# In Render Shell
python manage.py migrate --noinput
```

---

## Media Files Configuration

### ‚ö†Ô∏è Important: Ephemeral Storage Warning

Render's free tier uses **ephemeral storage**. This means:

- ‚ùå Uploaded files (resumes, profile pictures) are **deleted** on every deployment or restart
- ‚ùå Not suitable for production user uploads
- ‚úÖ OK for testing and development

### Production Solutions

For production, configure cloud storage:

#### Option 1: AWS S3 (Recommended)

1. Install django-storages:
   ```bash
   pip install django-storages boto3
   ```

2. Add to `settings.py`:
   ```python
   # settings.py
   if not DEBUG:
       DEFAULT_FILE_STORAGE = 'storages.backends.s3boto3.S3Boto3Storage'
       AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
       AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
       AWS_STORAGE_BUCKET_NAME = os.environ.get('AWS_STORAGE_BUCKET_NAME')
       AWS_S3_REGION_NAME = os.environ.get('AWS_S3_REGION_NAME', 'us-east-1')
   ```

3. Set environment variables in Render

#### Option 2: Cloudinary

1. Install cloudinary:
   ```bash
   pip install cloudinary django-cloudinary-storage
   ```

2. Configure in `settings.py`

#### Option 3: Render Disk (Paid)

1. In Render Dashboard, add a disk to your web service
2. Mount at `/opt/render/project/src/media`
3. Note: Only works with paid plans ($7/month minimum)

---

## Next Steps

After successful deployment:

1. ‚úÖ Update Flutter app API endpoint to your Render URL
2. ‚úÖ Configure custom domain (optional)
3. ‚úÖ Set up monitoring and alerts
4. ‚úÖ Configure cloud storage for media files
5. ‚úÖ Set up automated backups for database
6. ‚úÖ Review and optimize performance

---

## Support & Resources

- **Render Documentation**: https://render.com/docs
- **Django Deployment Checklist**: https://docs.djangoproject.com/en/stable/howto/deployment/checklist/
- **Project Issues**: Create an issue in your GitHub repository

---

## Security Checklist

Before going live:

- [ ] `DEBUG = False` in production
- [ ] Strong `SECRET_KEY` (auto-generated)
- [ ] `ALLOWED_HOSTS` restricted to your domain
- [ ] `CORS_ALLOWED_ORIGINS` restricted to your app
- [ ] Database credentials secured (environment variables)
- [ ] HTTPS enabled (automatic on Render)
- [ ] Regular security updates (`pip install --upgrade`)

---

**Deployment Date**: {{ DATE }}  
**Django Version**: 5.1.15  
**Python Version**: 3.11.0  
**Render Region**: Singapore
